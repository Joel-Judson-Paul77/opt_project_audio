<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ™ï¸ Live Audio Classroom</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <h1>ğŸ§ Live Audio Classroom</h1>
  <label><input type="radio" name="role" value="teacher"> Teacher</label>
  <label><input type="radio" name="role" value="student" checked> Student</label>
  <br><br>
  <button id="startBtn" disabled>Start Recording</button>
  <button id="stopBtn" disabled>Stop Recording</button>
  <p id="status">Please select a role</p>
  <audio id="player" controls autoplay></audio><br>
  <a id="downloadLink" href="#" style="display:none;" download>â¬‡ï¸ Download MP3</a>

  <script>
    const socket = io("http://127.0.0.1:5003"); // use localhost for testing
    let mediaRecorder, mediaSource, sourceBuffer, audioQueue = [];
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const status = document.getElementById("status");
    const player = document.getElementById("player");
    const downloadLink = document.getElementById("downloadLink");
    let role = "student";
    const session_id = "test123";

    // Role select
    document.querySelectorAll("input[name=role]").forEach(radio => {
      radio.addEventListener("change", (e) => {
        role = e.target.value;
        if (role === "teacher") {
          startBtn.disabled = false;
          status.innerText = "ğŸ¤ Teacher mode: Ready to record";
        } else {
          startBtn.disabled = true;
          stopBtn.disabled = true;
          status.innerText = "ğŸ§ Student mode: Waiting for teacher audio";
        }
      });
    });

    socket.on("connect", () => {
      status.innerText = "âœ… Connected as " + role;
      socket.emit("join_session", { session_id: session_id });
    });

    // Teacher mode
    startBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          const reader = new FileReader();
          reader.onloadend = () => {
            const base64data = reader.result.split(",")[1];
            socket.emit("audio_chunk", { session_id: session_id, chunk: base64data });
          };
          reader.readAsDataURL(event.data);
        }
      };
      mediaRecorder.start(500);
      startBtn.disabled = true;
      stopBtn.disabled = false;
      status.innerText = "ğŸ™ï¸ Recording...";
    };

    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
      socket.emit("stop_recording", { session_id: session_id });
      startBtn.disabled = false;
      stopBtn.disabled = true;
      status.innerText = "ğŸ›‘ Recording stopped. Converting...";
    };

    // Student mode (live playback)
    mediaSource = new MediaSource();
    player.src = URL.createObjectURL(mediaSource);
    mediaSource.addEventListener("sourceopen", () => {
      sourceBuffer = mediaSource.addSourceBuffer('audio/webm; codecs=opus');
      sourceBuffer.addEventListener("updateend", () => {
        if (audioQueue.length > 0 && !sourceBuffer.updating) {
          sourceBuffer.appendBuffer(audioQueue.shift());
        }
      });
    });
    socket.on("audio_chunk", (data) => {
      const byteArray = Uint8Array.from(atob(data.chunk), c => c.charCodeAt(0));
      if (sourceBuffer && !sourceBuffer.updating) {
        sourceBuffer.appendBuffer(byteArray);
      } else {
        audioQueue.push(byteArray);
      }
    });

    // Recording ready
    socket.on("recording_ready", (data) => {
      status.innerText = "âœ… Recording converted!";
      downloadLink.href = "http://127.0.0.1:5003" + data.file;
      downloadLink.style.display = "block";
    });
  </script>
</body>
</html>
